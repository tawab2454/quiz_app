{% extends "base.html" %}

{% block title %}Register - Online Examination System{% endblock %}

{% block content %}
<div class="auth-container register-portal">
    <div class="auth-card">
        <div class="auth-header">
            <h2>üì° New Registration</h2>
            <p>Initialize Security Clearance Protocol</p>
            <div class="auth-notice">
                <span class="notice-icon">üîí</span>
                <span class="notice-text">Additional information will be collected securely after login</span>
            </div>
        </div>

        {% if registration_open is defined and not registration_open %}
            <div class="register-disabled" style="text-align:center; padding:40px;">
                <h3 style="color:#c0392b;">Registration Disabled by Administrator</h3>
                <p>New user registrations are temporarily closed. Please contact your administrator or try again later.</p>
                <p><a href="{{ url_for('index') }}" class="footer-link footer-link-secondary">‚Üê Return to Command Center</a></p>
            </div>
        {% else %}

        <form method="POST" class="form" id="registerForm" action="{{ url_for('register') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <!-- NSI ID Field -->
            <div class="form-group">
                <label class="auth-label" for="nsi_id">NSI ID *</label>
                <input type="text" id="nsi_id" name="nsi_id" required 
                       placeholder="e.g., A-0561" maxlength="6"
                       class="auth-input" autocomplete="username">
                <div class="auth-help">
                    <span class="cyber-icon">‚ÑπÔ∏è</span> Protocol: [A-D]-[0-9]{4}<br>
                    <span class="cyber-icon">üîç</span> Example Input: A-0561
                </div>
            </div>

            <!-- Name Field -->
            <div class="form-group">
                <label class="auth-label" for="name">Operative Name *</label>
                <input type="text" id="name" name="name" required 
                       placeholder="Enter your full name" maxlength="100"
                       class="auth-input" autocomplete="name">
            </div>

            <!-- Password Field -->
            <div class="form-group">
                <label class="auth-label" for="password">Password *</label>
                <div class="password-input-wrapper">
                    <input type="password" id="password" name="password" required 
                           placeholder="Enter your password" minlength="6" maxlength="100"
                           class="auth-input" autocomplete="new-password">
                    <button type="button" class="password-toggle-btn" id="togglePassword" aria-label="Toggle password visibility">
                        <span class="eye-icon">üëÅÔ∏è</span>
                    </button>
                </div>
                <div class="auth-help password-requirements">
                    <strong style="color: #00bfff;">üîí Password Requirements:</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0; list-style: none;">
                        <li id="req-length" style="color: #666;">‚úó Minimum 6 characters</li>
                        <li id="req-weak" style="color: #666;">‚úó Avoid weak passwords (password, 123456, admin, qwerty, abc123)</li>
                        <li id="req-match" style="color: #666;">‚úó Passwords must match</li>
                    </ul>
                </div>
                <div id="passwordStrength" class="auth-help"></div>
            </div>

            <!-- Confirm Password Field -->
            <div class="form-group">
                <label class="auth-label" for="confirm_password">Re-enter Password *</label>
                <div class="password-input-wrapper">
                    <input type="password" id="confirm_password" name="confirm_password" required 
                           placeholder="Re-enter your password" maxlength="100"
                           class="auth-input" autocomplete="new-password">
                    <button type="button" class="password-toggle-btn" id="toggleConfirmPassword" aria-label="Toggle confirm password visibility">
                        <span class="eye-icon">üëÅÔ∏è</span>
                    </button>
                </div>
                <div id="passwordMatch" class="auth-help"></div>
            </div>

            <button type="submit" class="auth-button">üöÄ Complete Registration</button>
            
            <div class="form-info-box">
                <div class="info-icon">üí°</div>
                <div class="info-content">
                    <strong>Next Steps:</strong>
                    <p>After registration, you'll complete your profile with additional information in a secure environment.</p>
                </div>
            </div>
        </form>

        <div class="auth-footer">
            <div class="footer-link-container">
                <span class="footer-text">Existing operative?</span>
                <a href="{{ url_for('login') }}" class="footer-link footer-link-primary">
                    <span class="link-icon">üîì</span>
                    <span class="link-text">Access Portal</span>
                </a>
            </div>
            <div class="footer-divider"></div>
            <a href="{{ url_for('index') }}" class="footer-link footer-link-secondary">
                <span class="link-icon">‚Üê</span>
                <span class="link-text">Return to Command Center</span>
            </a>
        </div>
    </div>
        {% endif %}
</div>

<style>
.auth-notice {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.75rem;
    background: rgba(0, 191, 255, 0.1);
    border: 1px solid rgba(0, 191, 255, 0.3);
    border-radius: 8px;
}

.notice-icon {
    font-size: 1.2rem;
}

.notice-text {
    color: var(--cyber-text);
    font-size: 0.9rem;
    font-family: var(--font-mono);
}

.form-info-box {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    padding: 1rem;
    margin-top: 1.5rem;
    background: linear-gradient(135deg, rgba(0, 191, 255, 0.05) 0%, rgba(0, 229, 255, 0.05) 100%);
    border: 1px solid rgba(0, 191, 255, 0.2);
    border-radius: 10px;
}

.info-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.info-content {
    flex: 1;
}

.info-content strong {
    color: var(--cyber-primary);
    font-size: 0.95rem;
    display: block;
    margin-bottom: 0.25rem;
}

.info-content p {
    color: var(--cyber-text-dim);
    font-size: 0.85rem;
    margin: 0;
    line-height: 1.4;
}
</style>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const nsiIdInput = document.getElementById('nsi_id');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const passwordStrength = document.getElementById('passwordStrength');
    const passwordMatch = document.getElementById('passwordMatch');
    const form = document.getElementById('registerForm');
    
    // Password toggle functionality
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    
    if (togglePassword) {
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.querySelector('.eye-icon').textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        });
    }
    
    if (toggleConfirmPassword) {
        toggleConfirmPassword.addEventListener('click', function() {
            const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPasswordInput.setAttribute('type', type);
            this.querySelector('.eye-icon').textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        });
    }

    // NSI ID normalization
    function normalizeNsiId(value) {
        // Remove all whitespace and convert to uppercase
        let normalized = value.trim().toUpperCase().replace(/\s+/g, '');
        
        // If user typed something like "A 1234" or "A1234", format it to "A-1234"
        const match = normalized.match(/^([A-D])[\s\-]?(\d{4})$/);
        if (match) {
            return `${match[1]}-${match[2]}`;
        }
        return normalized;
    }

    if (nsiIdInput) {
        nsiIdInput.addEventListener('blur', function() {
            this.value = normalizeNsiId(this.value);
        });
        
        nsiIdInput.addEventListener('input', function() {
            // Auto-format as user types
            let val = this.value.toUpperCase().replace(/\s+/g, '');
            // Insert hyphen if user typed letter + 4 digits
            const autoMatch = val.match(/^([A-D])(\d{1,4})$/);
            if (autoMatch && autoMatch[2].length > 0) {
                this.value = `${autoMatch[1]}-${autoMatch[2]}`;
            }
            
            // Validate format
            const validFormat = /^[A-D]-\d{4}$/.test(this.value);
            if (this.value.length >= 6) {
                if (validFormat) {
                    this.classList.remove('input-error');
                    this.classList.add('input-success');
                } else {
                    this.classList.add('input-error');
                    this.classList.remove('input-success');
                }
            } else {
                this.classList.remove('input-error', 'input-success');
            }
        });
    }

    // Password requirements real-time validation
    const reqLength = document.getElementById('req-length');
    const reqWeak = document.getElementById('req-weak');
    const reqMatch = document.getElementById('req-match');
    
    function validatePasswordRequirements() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const weakPatterns = ['password', '123456', 'admin', 'qwerty', 'abc123'];
        
        // Check length requirement
        if (password.length >= 6) {
            reqLength.style.color = '#00cc44';
            reqLength.innerHTML = '‚úì Minimum 6 characters';
        } else {
            reqLength.style.color = password.length > 0 ? '#ff4444' : '#666';
            reqLength.innerHTML = '‚úó Minimum 6 characters';
        }
        
        // Check weak password patterns
        const isWeak = weakPatterns.some(pattern => password.toLowerCase().includes(pattern));
        if (password.length > 0) {
            if (!isWeak) {
                reqWeak.style.color = '#00cc44';
                reqWeak.innerHTML = '‚úì Not a common weak password';
            } else {
                reqWeak.style.color = '#ff4444';
                reqWeak.innerHTML = '‚úó Avoid weak passwords (password, 123456, admin, qwerty, abc123)';
            }
        } else {
            reqWeak.style.color = '#666';
            reqWeak.innerHTML = '‚úó Avoid weak passwords (password, 123456, admin, qwerty, abc123)';
        }
        
        // Check password match
        if (confirmPassword.length > 0) {
            if (password === confirmPassword && password.length > 0) {
                reqMatch.style.color = '#00cc44';
                reqMatch.innerHTML = '‚úì Passwords match';
            } else {
                reqMatch.style.color = '#ff4444';
                reqMatch.innerHTML = '‚úó Passwords must match';
            }
        } else {
            reqMatch.style.color = '#666';
            reqMatch.innerHTML = '‚úó Passwords must match';
        }
    }

    // Password strength indicator
    passwordInput.addEventListener('input', function() {
        validatePasswordRequirements();
        
        const password = this.value;
        let strength = 0;
        let message = '';
        let color = '';

        if (password.length >= 6) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        switch (strength) {
            case 0:
            case 1:
                message = 'Very Weak';
                color = '#ff4444';
                break;
            case 2:
                message = 'Weak';
                color = '#ff8800';
                break;
            case 3:
                message = 'Fair';
                color = '#ffaa00';
                break;
            case 4:
                message = 'Good';
                color = '#88cc00';
                break;
            case 5:
                message = 'Strong';
                color = '#00cc44';
                break;
        }

        if (passwordStrength) {
            passwordStrength.textContent = password ? `Strength: ${message}` : '';
            passwordStrength.style.color = color;
        }
    });

    // Password match indicator
    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (!passwordMatch) return;
        if (confirmPassword) {
            if (password === confirmPassword) {
                passwordMatch.textContent = '‚úì Passwords match';
                passwordMatch.style.color = '#00cc44';
            } else {
                passwordMatch.textContent = '‚úó Passwords do not match';
                passwordMatch.style.color = '#ff4444';
            }
        } else {
            passwordMatch.textContent = '';
        }
    }

    passwordInput.addEventListener('input', checkPasswordMatch);
    confirmPasswordInput.addEventListener('input', function() {
        validatePasswordRequirements();
        checkPasswordMatch();
    });

    // Form validation
    form.addEventListener('submit', function(e) {
        // Normalize NSI ID one last time before validating/submitting
        const nsiIdNormalized = normalizeNsiId(nsiIdInput.value);
        nsiIdInput.value = nsiIdNormalized;
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // Validate NSI ID format
        if (!nsiIdNormalized || !/^[A-D]-[0-9]{4}$/.test(nsiIdNormalized)) {
            e.preventDefault();
            alert('Please enter a valid NSI ID format (e.g., A-1234)');
            nsiIdInput.focus();
            return;
        }

        // Validate password length
        if (password.length < 6) {
            e.preventDefault();
            alert('Password must be at least 6 characters long!');
            passwordInput.focus();
            return;
        }
        
        // Validate weak passwords
        const weakPatterns = ['password', '123456', 'admin', 'qwerty', 'abc123'];
        const isWeak = weakPatterns.some(pattern => password.toLowerCase().includes(pattern));
        if (isWeak) {
            e.preventDefault();
            alert('Password is too weak! Please avoid using common passwords like "password", "123456", "admin", "qwerty", or "abc123".');
            passwordInput.focus();
            return;
        }
        
        // Validate password match
        if (password !== confirmPassword) {
            e.preventDefault();
            alert('Passwords do not match!');
            confirmPasswordInput.focus();
            return;
        }

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.textContent = 'üîÑ Registering...';
        submitBtn.disabled = true;
    });

    // Debug: Log to console if elements are found
    console.log('NSI ID Input:', nsiIdInput);
    console.log('Form:', form);
});
</script>
{% endblock %}
