{% extends "base.html" %}

{% block title %}Register - Online Examination System{% endblock %}

{% block content %}
<div class="auth-container register-portal">
    <div class="auth-card">
        <div class="auth-header">
            <h2>üì° New Registration</h2>
            <p>Initialize Security Clearance Protocol</p>
        </div>

        {% if registration_open is defined and not registration_open %}
            <div class="register-disabled" style="text-align:center; padding:40px;">
                <h3 style="color:#c0392b;">Registration Disabled by Administrator</h3>
                <p>New user registrations are temporarily closed. Please contact your administrator or try again later.</p>
                <p><a href="{{ url_for('index') }}" class="auth-link">‚Üê Return to Command Center</a></p>
            </div>
        {% else %}

        <form method="POST" class="form" id="registerForm" action="{{ url_for('register') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="form-group">
                <label class="auth-label" for="nsi_id">NSI ID *</label>
                <input type="text" id="nsi_id" name="nsi_id" required 
                       placeholder="e.g., A-0561" maxlength="6"
                       class="auth-input">
                <div class="auth-help">
                    <span class="cyber-icon">‚ÑπÔ∏è</span> Protocol: [A-D]-[0-9]{4}<br>
                    <span class="cyber-icon">üîç</span> Example Input: A-0561
                </div>
            </div>

            <div class="form-group">
                <label class="auth-label" for="name">Operative Name *</label>
                <input type="text" id="name" name="name" required 
                       placeholder="Enter operative designation" maxlength="100"
                       class="auth-input">
            </div>

            <div class="form-group">
                <label class="auth-label" for="wing_name">Wing Name</label>
                <select id="wing_name" name="wing_name" required class="auth-input">
                    <option value="">Select Wing</option>
                    <option value="Technical Intelligence Wing">Technical Intelligence Wing</option>
                    <option value="Admin Wing">Admin Wing</option>
                    <option value="External Affairs & Liasons Wing">External Affairs & Liasons Wing</option>
                    <option value="Political Wing">Political Wing</option>
                    <option value="Research Wing">Research Wing</option>
                    <option value="Special Affairs Wing">Special Affairs Wing</option>
                    <option value="DG Secretariat">DG Secretariat</option>
                    <option value="DG Coordination">DG Coordination</option>
                    <option value="Economic Security Wing">Economic Security Wing</option>
                    <option value="Internal Wing">Internal Wing</option>
                    <option value="Border Wing">Border Wing</option>
                    <option value="Counter Terrorism Wing">Counter Terrorism Wing</option>
                    <option value="Dhaka Wing">Dhaka Wing</option>
                    <option value="Media Wing">Media Wing</option>
                    <option value="Training Institute Wing">Training Institute Wing</option>
                    <option value="CTcell">CTcell</option>
                </select>
            </div>

            <!-- Internal Wing Type - only shown for Internal Wing -->
            <div class="form-group" id="internal_type_group" style="display: none;">
                <label class="auth-label" for="internal_type">Internal Wing Type *</label>
                <select id="internal_type" name="internal_type" class="auth-input">
                    <option value="">Select Type</option>
                    <option value="HQ">HQ</option>
                    <option value="Others">Others</option>
                </select>
            </div>

            <!-- Border Wing Type - only shown for Border Wing -->
            <div class="form-group" id="border_type_group" style="display: none;">
                <label class="auth-label" for="border_type">Border Wing Type *</label>
                <select id="border_type" name="border_type" class="auth-input">
                    <option value="">Select Type</option>
                    <option value="HQ">HQ</option>
                    <option value="Others">Others</option>
                </select>
            </div>

            <!-- External Affairs Wing Type - only shown for External Affairs Wing -->
            <div class="form-group" id="external_type_group" style="display: none;">
                <label class="auth-label" for="external_type">Office Location *</label>
                <select id="external_type" name="external_type" class="auth-input">
                    <option value="">Select Location</option>
                    <option value="Inside BD">Inside BD</option>
                    <option value="Outside BD">Outside BD</option>
                </select>
            </div>

            <!-- Country Field - only shown for External Affairs Wing Outside BD -->
            <div class="form-group" id="country_group" style="display: none;">
                <label class="auth-label" for="country_name">Country *</label>
                <select id="country_name" name="country_name" class="auth-input">
                    <option value="">Select Country</option>
                    <option value="India">India</option>
                    <option value="UAE">UAE</option>
                    <option value="UK">UK</option>
                    <option value="USA">USA</option>
                    <option value="Pakistan">Pakistan</option>
                    <option value="Nepal">Nepal</option>
                    <option value="Malaysia">Malaysia</option>
                    <option value="KSA">KSA</option>
                    <option value="Myanmar">Myanmar</option>
                </select>
            </div>

            <div class="form-group" id="section_group">
                <label class="auth-label" for="section_name">Section Name</label>
                <input type="text" id="section_name" name="section_name" 
                       placeholder="Enter your section name" maxlength="30"
                       class="auth-input">
            </div>

            <div class="form-group" id="division_group" style="display: none;">
                <label class="auth-label" for="division_name">Division Name *</label>
                <select id="division_name" name="division_name" class="auth-input">
                    <option value="">Select Division</option>
                    <option value="Dhaka">Dhaka</option>
                    <option value="Chattogram">Chattogram</option>
                    <option value="Rajshahi">Rajshahi</option>
                    <option value="Khulna">Khulna</option>
                    <option value="Barishal">Barishal</option>
                    <option value="Mymensingh">Mymensingh</option>
                    <option value="Rangpur">Rangpur</option>
                    <option value="Sylhet">Sylhet</option>
                    <option value="Faridpur">Faridpur (proposed)</option>
                    <option value="Chittagong Hill Tracts (Parbatya Chattagram)">Chittagong Hill Tracts (Parbatya Chattagram)</option>
                </select>
            </div>

            <div class="form-group" id="district_group" style="display: none;">
                <label class="auth-label" for="district_name">District Name *</label>
                <select id="district_name" name="district_name" class="auth-input">
                    <option value="">Select District</option>
                </select>
            </div>

                        <div class="form-group">
                            <label class="auth-label" for="password">Password *</label>
                            <input type="password" id="password" name="password" required 
                                   placeholder="Enter your password" maxlength="100"
                                   class="auth-input">
                            <div id="passwordStrength" class="auth-help"></div>
                        </div>

            <div class="form-group">
                <label class="auth-label" for="confirm_password">Re-enter Password *</label>
                <input type="password" id="confirm_password" name="confirm_password" required 
                       placeholder="Re-enter your password" maxlength="100"
                       class="auth-input">
                <div id="passwordMatch" class="auth-help"></div>
            </div>

            <button type="submit" class="auth-button">Submit Registration</button>
        </form>

        <div class="auth-footer">
            <p class="auth-link">Existing operative? <a href="{{ url_for('login') }}">Access portal</a></p>
            <p class="auth-link"><a href="{{ url_for('index') }}">‚Üê Return to Command Center</a></p>
        </div>
    </div>
        {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const nsiIdInput = document.getElementById('nsi_id');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const passwordStrength = document.getElementById('passwordStrength');
    const passwordMatch = document.getElementById('passwordMatch');
    const form = document.getElementById('registerForm');

    // Division -> District mapping
    const allDivisionDistricts = {
        'Rajshahi': [
            'Rajshahi', 'Naogaon', 'Natore', 'Chapai Nawabganj', 'Pabna', 'Bogura', 'Sirajganj', 'Joypurhat'
        ],
        'Dhaka': [
            'Dhaka', 'Tangail', 'Narsingdi', 'Gazipur', 'Munshiganj', 'Narayanganj', 'Manikganj', 'Kishoreganj'
        ],
        'Chattogram': [
            'Chattogram', 'Cumilla', 'Brahmanbaria', 'Chandpur', 'Noakhali', 'Feni', 'Lakshmipur'
        ],
        'Khulna': [
            'Khulna', 'Bagerhat', 'Satkhira', 'Jashore (Jessore)', 'Narail', 'Jhenaidah', 'Magura', 'Kushtia', 'Chuadanga', 'Meherpur'
        ],
        'Rangpur': [
            'Rangpur', 'Kurigram', 'Lalmonirhat', 'Nilphamari', 'Gaibandha', 'Dinajpur', 'Thakurgaon', 'Panchagarh'
        ],
        'Barishal': [
            'Barishal', 'Patuakhali', 'Bhola', 'Pirojpur', 'Barguna', 'Jhalokathi'
        ],
        'Mymensingh': [
            'Mymensingh', 'Jamalpur', 'Sherpur', 'Netrokona'
        ],
        'Sylhet': [
            'Sylhet', 'Sunamganj', 'Moulvibazar', 'Habiganj'
        ],
        'Faridpur': [
            'Faridpur', 'Rajbari', 'Shariatpur', 'Gopalganj', 'Madaripur'
        ],
        'Chittagong Hill Tracts (Parbatya Chattagram)': [
            'Rangamati', 'Bandarban', 'Khagrachhari', 'Cox\'s Bazar'
        ]
    };

    // Divisions for Internal Wing (all except CHT)
    const internalDivisions = [
        'Dhaka', 'Chattogram', 'Rajshahi', 'Khulna', 'Barishal', 
        'Mymensingh', 'Rangpur', 'Sylhet', 'Faridpur'
    ];

    // Divisions for Border Wing (only CHT)
    const borderDivisions = [
        'Chittagong Hill Tracts (Parbatya Chattagram)'
    ];    const wingSelect = document.getElementById('wing_name');
    const internalTypeSelect = document.getElementById('internal_type');
    const borderTypeSelect = document.getElementById('border_type');
    const externalTypeSelect = document.getElementById('external_type');
    const divisionSelect = document.getElementById('division_name');
    const districtSelect = document.getElementById('district_name');
    const countrySelect = document.getElementById('country_name');
    const internalTypeGroup = document.getElementById('internal_type_group');
    const borderTypeGroup = document.getElementById('border_type_group');
    const externalTypeGroup = document.getElementById('external_type_group');
    const sectionGroup = document.getElementById('section_group');
    const divisionGroup = document.getElementById('division_group');
    const districtGroup = document.getElementById('district_group');
    const countryGroup = document.getElementById('country_group');

    function populateDivisions(divisions) {
        // Reset division options
        divisionSelect.innerHTML = '<option value="">Select Division</option>';
        divisions.forEach(division => {
            const opt = document.createElement('option');
            opt.value = division;
            opt.textContent = division;
            divisionSelect.appendChild(opt);
        });
    }

    function populateDistricts(division) {
        // Reset options
        districtSelect.innerHTML = '<option value="">Select District</option>';
        const list = allDivisionDistricts[division] || [];
        list.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            districtSelect.appendChild(opt);
        });
    }

    // Wing selection change handler
    function handleWingChange() {
        const selectedWing = wingSelect.value;
        const isInternalWing = selectedWing === 'Internal Wing';
        const isBorderWing = selectedWing === 'Border Wing';
        const isExternalWing = selectedWing === 'External Affairs & Liasons Wing';
        
        if (isInternalWing) {
            // Show internal type selection, hide other types
            internalTypeGroup.style.display = 'block';
            borderTypeGroup.style.display = 'none';
            externalTypeGroup.style.display = 'none';
            internalTypeSelect.setAttribute('required', 'required');
            borderTypeSelect.removeAttribute('required');
            externalTypeSelect.removeAttribute('required');
            borderTypeSelect.value = '';
            externalTypeSelect.value = '';
        } else if (isBorderWing) {
            // Show border type selection, hide other types
            borderTypeGroup.style.display = 'block';
            internalTypeGroup.style.display = 'none';
            externalTypeGroup.style.display = 'none';
            borderTypeSelect.setAttribute('required', 'required');
            internalTypeSelect.removeAttribute('required');
            externalTypeSelect.removeAttribute('required');
            internalTypeSelect.value = '';
            externalTypeSelect.value = '';
        } else if (isExternalWing) {
            // Show external type selection, hide other types
            externalTypeGroup.style.display = 'block';
            internalTypeGroup.style.display = 'none';
            borderTypeGroup.style.display = 'none';
            externalTypeSelect.setAttribute('required', 'required');
            internalTypeSelect.removeAttribute('required');
            borderTypeSelect.removeAttribute('required');
            internalTypeSelect.value = '';
            borderTypeSelect.value = '';
        } else {
            // Hide all wing type fields and show section for other wings
            internalTypeGroup.style.display = 'none';
            borderTypeGroup.style.display = 'none';
            externalTypeGroup.style.display = 'none';
            sectionGroup.style.display = 'block';
            divisionGroup.style.display = 'none';
            districtGroup.style.display = 'none';
            countryGroup.style.display = 'none';
            
            // Remove required attributes and clear values
            internalTypeSelect.removeAttribute('required');
            borderTypeSelect.removeAttribute('required');
            externalTypeSelect.removeAttribute('required');
            countrySelect.removeAttribute('required');
            divisionSelect.removeAttribute('required');
            districtSelect.removeAttribute('required');
            internalTypeSelect.value = '';
            borderTypeSelect.value = '';
            externalTypeSelect.value = '';
            countrySelect.value = '';
            divisionSelect.value = '';
            districtSelect.innerHTML = '<option value="">Select District</option>';
        }
    }

    // Internal type selection change handler
    function handleInternalTypeChange() {
        const selectedType = internalTypeSelect.value;
        const isHQ = selectedType === 'HQ';
        const isOthers = selectedType === 'Others';
        
        if (isHQ) {
            // Show section field only for HQ
            sectionGroup.style.display = 'block';
            divisionGroup.style.display = 'none';
            districtGroup.style.display = 'none';
            
            // Remove required attributes for division/district
            divisionSelect.removeAttribute('required');
            districtSelect.removeAttribute('required');
            divisionSelect.value = '';
            districtSelect.innerHTML = '<option value="">Select District</option>';
        } else if (isOthers) {
            // Show division and district fields only, hide section
            sectionGroup.style.display = 'none';
            divisionGroup.style.display = 'block';
            districtGroup.style.display = 'block';
            
            // Populate internal divisions (excluding CHT)
            populateDivisions(internalDivisions);
            
            // Make division/district required for Others
            divisionSelect.setAttribute('required', 'required');
            districtSelect.setAttribute('required', 'required');
        } else {
            // Hide all fields when no internal type is selected
            sectionGroup.style.display = 'none';
            divisionGroup.style.display = 'none';
            districtGroup.style.display = 'none';
            
            // Remove required attributes and clear values
            divisionSelect.removeAttribute('required');
            districtSelect.removeAttribute('required');
            divisionSelect.value = '';
            districtSelect.innerHTML = '<option value="">Select District</option>';
        }
    }

    // Border type selection change handler
    function handleBorderTypeChange() {
        const selectedType = borderTypeSelect.value;
        const isHQ = selectedType === 'HQ';
        const isOthers = selectedType === 'Others';
        
        if (isHQ) {
            // Show section field only for HQ
            sectionGroup.style.display = 'block';
            divisionGroup.style.display = 'none';
            districtGroup.style.display = 'none';
            
            // Remove required attributes for division/district
            divisionSelect.removeAttribute('required');
            districtSelect.removeAttribute('required');
            divisionSelect.value = '';
            districtSelect.innerHTML = '<option value="">Select District</option>';
        } else if (isOthers) {
            // Show division and district fields only, hide section
            sectionGroup.style.display = 'none';
            divisionGroup.style.display = 'block';
            districtGroup.style.display = 'block';
            
            // Populate border divisions (only CHT)
            populateDivisions(borderDivisions);
            
            // Make division/district required for Others
            divisionSelect.setAttribute('required', 'required');
            districtSelect.setAttribute('required', 'required');
        } else {
            // Hide all fields when no border type is selected
            sectionGroup.style.display = 'none';
            divisionGroup.style.display = 'none';
            districtGroup.style.display = 'none';
            
            // Remove required attributes and clear values
            divisionSelect.removeAttribute('required');
            districtSelect.removeAttribute('required');
            divisionSelect.value = '';
            districtSelect.innerHTML = '<option value="">Select District</option>';
        }
    }

    // External Affairs type selection change handler
    function handleExternalTypeChange() {
        const selectedType = externalTypeSelect.value;
        const isInsideBD = selectedType === 'Inside BD';
        const isOutsideBD = selectedType === 'Outside BD';
        
        if (isInsideBD) {
            // Show section field only for Inside BD
            sectionGroup.style.display = 'block';
            countryGroup.style.display = 'none';
            divisionGroup.style.display = 'none';
            districtGroup.style.display = 'none';
            
            // Remove required attributes for country
            countrySelect.removeAttribute('required');
            divisionSelect.removeAttribute('required');
            districtSelect.removeAttribute('required');
            countrySelect.value = '';
            divisionSelect.value = '';
            districtSelect.innerHTML = '<option value="">Select District</option>';
        } else if (isOutsideBD) {
            // Show country field only for Outside BD
            sectionGroup.style.display = 'none';
            countryGroup.style.display = 'block';
            divisionGroup.style.display = 'none';
            districtGroup.style.display = 'none';
            
            // Make country required for Outside BD
            countrySelect.setAttribute('required', 'required');
            divisionSelect.removeAttribute('required');
            districtSelect.removeAttribute('required');
            divisionSelect.value = '';
            districtSelect.innerHTML = '<option value="">Select District</option>';
        } else {
            // Hide all fields when no external type is selected
            sectionGroup.style.display = 'none';
            countryGroup.style.display = 'none';
            divisionGroup.style.display = 'none';
            districtGroup.style.display = 'none';
            
            // Remove required attributes and clear values
            countrySelect.removeAttribute('required');
            divisionSelect.removeAttribute('required');
            districtSelect.removeAttribute('required');
            countrySelect.value = '';
            divisionSelect.value = '';
            districtSelect.innerHTML = '<option value="">Select District</option>';
        }
    }

    if (wingSelect) {
        wingSelect.addEventListener('change', handleWingChange);
        // Initialize on page load
        handleWingChange();
    }

    if (internalTypeSelect) {
        internalTypeSelect.addEventListener('change', handleInternalTypeChange);
        // Initialize on page load
        handleInternalTypeChange();
    }

    if (borderTypeSelect) {
        borderTypeSelect.addEventListener('change', handleBorderTypeChange);
        // Initialize on page load
        handleBorderTypeChange();
    }

    if (externalTypeSelect) {
        externalTypeSelect.addEventListener('change', handleExternalTypeChange);
        // Initialize on page load
        handleExternalTypeChange();
    }

    if (divisionSelect && districtSelect) {
        divisionSelect.addEventListener('change', function() {
            populateDistricts(this.value);
        });
        // Populate on load if preselected (edit scenario)
        if (divisionSelect.value) {
            populateDistricts(divisionSelect.value);
        }
    }

    // Helper: Normalize NSI ID to `X-0000` format from various user inputs (X in A-D)
    function normalizeNsiId(raw) {
        if (!raw) return '';
        let value = String(raw)
            .toUpperCase()
            // unify all dash variants to '-'
            .replace(/[\u2012\u2013\u2014\u2015\u2212]/g, '-')
            // remove whitespace
            .replace(/\s+/g, '')
            // keep only A-D, digits, and '-'
            .replace(/[^A-D-0-9]/g, '');

        if (!value) return '';

        const first = value[0] || '';
        if (!/[A-D]/.test(first)) {
            return '';
        }

    // Collect digits after the first char (strip any dashes)
    let digits = value.slice(1).replace(/-/g, '').replace(/[^0-9]/g, '');
    // Allow up to 4 digits (no padding so backspace works)
    digits = digits.slice(0, 4);

    // Only insert dash when there is at least one digit
    return digits.length ? `${first}-${digits}` : first;
    }

    // NSI ID formatting
    nsiIdInput.addEventListener('input', function() {
        this.value = normalizeNsiId(this.value);
    });

    // Validate NSI ID on blur
    nsiIdInput.addEventListener('blur', function() {
        if (!this.value) return;
        const normalized = normalizeNsiId(this.value);
        this.value = normalized;
        if (normalized && !/^[A-D]-[0-9]{4}$/.test(normalized)) {
            alert('Please enter a valid NSI ID format (e.g., A-1234)');
            // keep value so user can adjust; highlight field
            this.classList.add('input-error');
        } else {
            this.classList.remove('input-error');
        }
    });

    // Password strength indicator
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        let strength = 0;
        let message = '';
        let color = '';

        if (password.length >= 6) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        switch (strength) {
            case 0:
            case 1:
                message = 'Very Weak';
                color = '#ff4444';
                break;
            case 2:
                message = 'Weak';
                color = '#ff8800';
                break;
            case 3:
                message = 'Fair';
                color = '#ffaa00';
                break;
            case 4:
                message = 'Good';
                color = '#88cc00';
                break;
            case 5:
                message = 'Strong';
                color = '#00cc44';
                break;
        }

        if (passwordStrength) {
            passwordStrength.textContent = password ? `Strength: ${message}` : '';
            passwordStrength.style.color = color;
        }
    });

    // Password match indicator
    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (!passwordMatch) return;
        if (confirmPassword) {
            if (password === confirmPassword) {
                passwordMatch.textContent = '‚úì Passwords match';
                passwordMatch.style.color = '#00cc44';
            } else {
                passwordMatch.textContent = '‚úó Passwords do not match';
                passwordMatch.style.color = '#ff4444';
            }
        } else {
            passwordMatch.textContent = '';
        }
    }

    passwordInput.addEventListener('input', checkPasswordMatch);
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);

    // Form validation
    form.addEventListener('submit', function(e) {
        // Normalize NSI ID one last time before validating/submitting
        const nsiIdNormalized = normalizeNsiId(nsiIdInput.value);
        nsiIdInput.value = nsiIdNormalized;
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const selectedWing = wingSelect.value;

        // Validate NSI ID format
        if (!nsiIdNormalized || !/^[A-D]-[0-9]{4}$/.test(nsiIdNormalized)) {
            e.preventDefault();
            alert('Please enter a valid NSI ID format (e.g., A-1234)');
            nsiIdInput.focus();
            return;
        }

        // Validate wing selection
        if (!selectedWing) {
            e.preventDefault();
            alert('Please select a wing');
            wingSelect.focus();
            return;
        }

        // Validate division and district for Internal Wing
        if (selectedWing === 'Internal Wing') {
            if (!divisionSelect.value) {
                e.preventDefault();
                alert('Please select a division for Internal Wing');
                divisionSelect.focus();
                return;
            }
            if (!districtSelect.value) {
                e.preventDefault();
                alert('Please select a district for Internal Wing');
                districtSelect.focus();
                return;
            }
        }

        // Validate password match
        if (password !== confirmPassword) {
            e.preventDefault();
            alert('Passwords do not match!');
            confirmPasswordInput.focus();
            return;
        }

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Registering...';
        submitBtn.disabled = true;
    });

    // Debug: Log to console if elements are found
    console.log('NSI ID Input:', nsiIdInput);
    console.log('Form:', form);
});
</script>
{% endblock %}